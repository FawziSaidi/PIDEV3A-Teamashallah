{% extends 'base.html.twig' %}
{% block title %}forum management interface{% endblock %}

{% block titre %}
<h1 class="h2 text-primary font-secondary" style="font-weight: bold; margin-bottom: 1.5rem; font-size: 2.5rem; text-transform: uppercase;">
Forum Management Panel</h1>
{% endblock %}

{% block description %}

   Admin Panel for Creating, Reading, Updating, and Deleting Forums
{% endblock %}

{% block buttonC %}
    <!-- this is the button which will trigger the Create Modal -->
    <div class="d-flex justify-content-end mb-3">
       <button class="btn" 
        style="background: linear-gradient(45deg, rgb(246, 174, 50), rgb(230, 140, 30)); 
               color: white; 
               border: none; 
               padding: 0.75rem 1.5rem; 
               border-radius: 8px; 
               font-weight: 500; 
               transition: background 0.3s ease, transform 0.2s ease;" 
        onmouseover="this.style.background='linear-gradient(45deg, rgb(230, 140, 30), rgb(246, 174, 50))'; this.style.transform='translateY(-2px)'" 
        onmouseout="this.style.background='linear-gradient(45deg, rgb(246, 174, 50), rgb(230, 140, 30))'; this.style.transform='translateY(0)'" 
        data-bs-toggle="modal" 
        data-bs-target="#createForumModal">
    <i class="bi bi-plus-lg me-2"></i> Create New Forum
</button>
    </div>
{% endblock %}
{% block body %}
    <div class="container mt-5">

 

        <div class="row">
            {% for forum in forums %}
              
     <div class="col-md-4 mb-4">
    <div class="card shadow-sm mb-4 border-0" style="background-color:rgb(233, 222, 195); color: white;">
        <div class="card-body">
            <!-- Card Title -->
            <h5 class="card-title fw-bold" style="color:rgb(39, 24, 0);">{{ forum.titleForum }}</h5>

            <!-- Card Description -->
            <p class="card-text" style="color: rgb(39, 24, 0);">{{ forum.descriptionForum }}</p>

            <!-- Card Category -->
            <p class="card-text">
                <small>
                    <span style="background-color:rgb(162, 146, 73); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">
                        Category: {{ forum.category }}
                    </span>
                </small>
            </p>

            <!-- Buttons -->
            <div class="d-flex gap-2">
                <!-- Edit Button -->
                <button class="btn btn-sm edit-button"
                        style="background-color:rgb(78, 51, 1); color: white; border: none;"
                        data-bs-toggle="modal"
                        data-bs-target="#editForumModal"
                        data-id="{{ forum.id }}"
                        data-title="{{ forum.titleForum }}"
                        data-description="{{ forum.descriptionForum }}"
                        data-category="{{ forum.category }}">
                    <i class="bi bi-pencil"></i> Edit
                </button>

                <!-- Delete Button -->
                <button class="btn btn-sm delete-button"
                        style="background-color: #d32f2f; color: white; border: none;"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteForumModal"
                        data-id="{{ forum.id }}"
                        data-csrf="{{ csrf_token('delete' ~ forum.id) }}">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>

        <!-- Card Footer: here i handled the Dates of a forum -->
        <div class="card-footer text-muted d-flex justify-content-between align-items-center" style="background-color: rgb(255, 249, 230); border-top: 1px solid rgb(162, 146, 73);">
            <div class="d-flex align-items-center">
                <i class="fas fa-calendar-alt me-2"></i>
                <span style="color: rgb(60, 61, 62); padding: 0.25rem 0.5rem; border-radius: 4px;">
                    Created at: {{ forum.createdAt|date("Y-m-d H:i") }}
                </span>
            </div>

            {% if forum.updatedAt is not null %}
                <div class="d-flex align-items-center">
                    <i class="fas fa-sync-alt me-2"></i>
                    <span style="color:rgb(101, 99, 98); padding: 0.25rem 0.5rem; border-radius: 4px;">
                        Edited: {{ forum.updatedAt|date("Y-m-d H:i") }}
                    </span>
                </div>
            {% endif %}
        </div>
    </div>
</div>

            {% else %}
                <p>No forums available.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Create Forum Modal -->
    <div class="modal fade" id="createForumModal" tabindex="-1" aria-labelledby="createForumModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!-- Modal Header -->
          <div class="modal-header" >
    <h5 class="modal-title">Create New Forum</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

            <!-- Modal Body -->
            <div class="modal-body">
                {{ form_start(createForm, {'attr': {'id': 'createForumForm', 'class': 'needs-validation' , 'novalidate': 'novalidate'}}) }}
                    <div class="mb-3">
                        {{ form_label(createForm.titleForum, 'Title', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(createForm.titleForum, {'attr': {'class': 'form-control', 'placeholder': 'Enter forum title'}}) }}
                        {{ form_errors(createForm.titleForum) }} 

                    </div>



                    <div class="mb-3">
                        {{ form_label(createForm.descriptionForum, 'Description', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(createForm.descriptionForum, {'attr': {'class': 'form-control', 'placeholder': 'Enter forum description', 'rows': 3}}) }}
                    
                    </div>

                    <div class="mb-3">
                        {{ form_label(createForm.category, 'Category', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(createForm.category, {'attr': {'class': 'form-control'}}) }}
                       
                    </div>
                    
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
<button type="button" class="btn btn-secondary"
        
       
        data-bs-dismiss="modal">
    Cancel
</button>                <button type="submit" class="btn btn-primary"   id="saveCreate">Create</button>
            </div>

          
                {{ form_end(createForm) }}



               
        </div>
    </div>
</div>

    <!-- Edit Forum Modal -->
    <div class="modal fade" id="editForumModal" tabindex="-1" aria-labelledby="editForumModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" id="saveCreate">
                    <h5 class="modal-title" id="editForumModalLabel" >Edit Forum</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForumForm" method="post">
                        <input type="hidden" id="editForumId" name="id">

                        <div class="mb-3">
                            <label for="editForumTitle" class="form-label">Title</label>
                            <input type="text" id="editForumTitle" name="titleForum" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="editForumDescription" class="form-label">Description</label>
                            <textarea id="editForumDescription" name="descriptionForum" class="form-control"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editForumCategory" class="form-label">Category</label>
                            <input type="text" id="editForumCategory" name="category" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"         
 data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary"  id="saveEdit">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteForumModal" tabindex="-1" aria-labelledby="deleteForumModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteForumModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this forum?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
<form id="deleteForumForm" method="post" data-turbo="false">
    <input type="hidden" name="_token" id="deleteCsrfToken">
    <button type="submit" class="btn btn-danger btn-sm" id="savedeletion">Delete</button>
</form>




                </div>
            </div>
        </div>
    </div>

    <script>
              // Here iam Handling edit form submission

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".edit-button").forEach(button => {
                button.addEventListener("click", function () {
                    document.getElementById("editForumId").value = this.getAttribute("data-id");
                    document.getElementById("editForumTitle").value = this.getAttribute("data-title");
                    document.getElementById("editForumDescription").value = this.getAttribute("data-description");
                    document.getElementById("editForumCategory").value = this.getAttribute("data-category");
                });
            });

            document.getElementById("saveEdit").addEventListener("click", function () {
                const form = document.getElementById("editForumForm");
                const formData = new FormData(form);
                
                fetch("/forum/edit/" + document.getElementById("editForumId").value, {
                    method: "POST",
                    body: formData
                }).then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        location.reload(); 

                    } else {
                                        alert( data.message);
                    }
                });
            });
          


          // Here iam Handling create form submission
        document.getElementById("saveCreate").addEventListener("click",async  function () {
            const form = document.getElementById("createForumForm");
            const formData = new FormData(form);

            fetch("/forum/create", {
                method: "POST",
                body: formData
            }).then(response =>  response.json())
            .then(data => {
                if (data.status === "success") {

                    location.reload(); 
                } else {
                                console.error('Error creating forum:', data.message);
                                        alert(data.message);
    }
            }).catch(error => {
                console.error("Error during fetch:", error);
            });
        });



          // Here iam Handling deletion of forum

         document.querySelectorAll(".delete-button").forEach(button => {
    button.addEventListener("click", function () {
        var forumId = this.getAttribute("data-id");
        var deleteForm = document.getElementById("deleteForumForm");
        deleteForm.action = "/forum/" + forumId;

        // I set the CSRF token dynamically
        var csrfTokenInput = document.getElementById("deleteCsrfToken");
        csrfTokenInput.value = this.getAttribute("data-csrf");









        
    });


});

    });


    </script>
{% endblock %}
