{% extends 'Forum/baseforum.html.twig' %}
{% block title %}forum management interface
{% endblock %}

{% block titre %}
	<!--<h1 class="h2 text-primary font-secondary" style="font-weight: bold; margin-bottom: 1.5rem; font-size: 2.5rem; text-transform: uppercase;">
	</h1>	-->Forum Management Panel
{% endblock %}

{% block description %}
<h3 class="h2 text-primary font-secondary" style="font-weight: bold; margin-bottom: 1.5rem; font-size: 2.5rem; text-transform: uppercase;">
		Admin Panel for Creating, Reading, Updating, and Deleting Forums
</h3>	
{% endblock %}

{% block buttonC %}
	<!-- Button to trigger the Create Modal -->
	<div class="d-flex justify-content-end mb-3" style="margin-right: auto;">
		<button class="btn"
			style="background: linear-gradient(45deg, #6a11cb, #2575fc);
				   color: white;
				   border: none;
				   padding: 0.75rem 1.5rem;
				   border-radius: 8px;
				   font-weight: 500;
				   transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
				   margin-left: -500px;
margin-top:220px;				   				                  margin-right: 20px;" 

			onmouseover="this.style.background='linear-gradient(45deg, #2575fc, #6a11cb)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0px 4px 10px rgba(0, 0, 0, 0.2)'"
    onmouseout="this.style.background='linear-gradient(45deg, #6a11cb, #2575fc)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"data-bs-toggle="modal" data-bs-target="#createForumModal">
			<i class="bi bi-plus-lg me-2"></i>
			add Forum
		</button>
	</div>
{% endblock %}

{% block body %}
	<div class="container mt-5">


		<div class="row">
			{% for forum in forums %}

				<div class="col-md-12 mb-4">
<div class="card shadow-sm border-0" style="background-color: #f5f5f5; color: #333; border: 1px solid #e0e0e0;">        <div class="card-body">
            <!-- Card Title -->
            <h5 class="card-title fw-bold" style="color: #212529;">{{ forum.titleForum }}</h5>

            <!-- Card Description -->
            <p class="card-text" style="color: #495057;">{{ forum.descriptionForum }}</p>

            <!-- Card Category -->
            <p class="card-text">
                <small>
 <span style="background-color:rgb(0, 94, 234); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">
                        Category: {{ forum.category }}
                    </span>                    
                </small>
            </p>


							<!-- Buttons -->
							<div
								class="d-flex gap-2">
								<!-- Edit Button -->
								<button class="btn btn-sm edit-button" style="background-color:rgb(27, 139, 5); color: white; border: none;" data-bs-toggle="modal" data-bs-target="#editForumModal" data-id="{{ forum.id }}" data-title="{{ forum.titleForum }}" data-description="{{ forum.descriptionForum }}" data-category="{{ forum.category }}">
									<i class="bi bi-pencil"></i>
								</button>

								<!-- Delete Button -->
								<button class="btn btn-sm delete-button" style="background-color:rgb(216, 32, 32); color: white; border: none;" data-bs-toggle="modal" data-bs-target="#deleteForumModal" data-id="{{ forum.id }}" data-csrf="{{ csrf_token('delete' ~ forum.id) }}">
									<i class="bi bi-trash"></i>
									
								</button>
							</div>
						</div>

						<!-- Card Footer: here i handled the Dates of a forum -->
						<div class="card-footer text-muted d-flex justify-content-between align-items-center" style="background-color: rgb(255, 255, 255); border-top: 1px solid rgb(245, 243, 229);">
							<div class="d-flex align-items-center">
								<i class="fas fa-calendar-alt me-2"></i>
								<span style="color: rgb(60, 61, 62); padding: 0.25rem 0.5rem; border-radius: 4px;">
									Created at:
									{{ forum.createdAt|date("Y-m-d H:i") }}
								</span>
							</div>

							{% if forum.updatedAt is not null %}
								<div class="d-flex align-items-center">
									<i class="fas fa-sync-alt me-2"></i>
									<span style="color:rgb(101, 99, 98); padding: 0.25rem 0.5rem; border-radius: 4px;">
										Edited at:
										{{ forum.updatedAt|date("Y-m-d H:i") }}
									</span>
								</div>
							{% endif %}
						</div>
					</div>
				</div>

			{% else %}
				<p>No forums available.</p>
			{% endfor %}
		</div>
	</div>

	<!-- Create Forum Modal -->
	<div class="modal fade" id="createForumModal" tabindex="-1" aria-labelledby="createForumModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div
				class="modal-content">
				<!-- Modal Header -->
				<div class="modal-header">
					<h5 class="modal-title">Create New Forum</h5>
					<button type="button" class="btn-close" style="filter: invert(1);" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>

				<!-- Modal Body -->
				<div class="modal-body">
					{{ form_start(createForm, {'attr': {'id': 'createForumForm', 'class': 'needs-validation', 'novalidate': 'novalidate'}}) }}

					<!-- General error message -->
					<div id="error-message" style="color: red; margin-top: 10px;"></div>

					<div class="mb-3">
						{{ form_label(createForm.titleForum, 'Title', {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(createForm.titleForum, {'attr': {'class': 'form-control', 'placeholder': 'Enter forum title'}}) }}
						{{ form_errors(createForm.titleForum)}}
						<!-- Error message for title -->
						<div class="error-message" id="titleForum-error" style="color: red; font-size: 14px;"></div>
					</div>

					<div class="mb-3">
						{{ form_label(createForm.descriptionForum, 'Description', {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(createForm.descriptionForum, {'attr': {'class': 'form-control', 'placeholder': 'Enter forum description', 'rows': 3}}) }}
						{{ form_errors(createForm.descriptionForum)}}
						<!-- Error message for description -->
						<div class="error-message" id="descriptionForum-error" style="color: red; font-size: 14px;"></div>
					</div>

					<div class="mb-3">
						{{ form_label(createForm.category, 'Category', {'label_attr': {'class': 'form-label'}}) }}
						{{ form_widget(createForm.category, {'attr': {'class': 'form-control'}}) }}
						{{ form_errors(createForm.category)}}
					</div>
				</div>

				<!-- Modal Footer -->
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						Cancel
					</button>
					<button type="submit" class="btn btn-primary" id="saveCreate">Create</button>
				</div>

				{{ form_end(createForm) }}


			</div>
		</div>
	</div>

    <!-- Edit Forum Modal -->

	 <div class="modal fade" id="editForumModal" tabindex="-1" aria-labelledby="editForumModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" id="saveCreate">
                    <h5 class="modal-title" id="editForumModalLabel" >Edit Forum</h5>
                    <button type="button" class="btn-close"     style="filter: invert(1);"
 data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForumForm" method="post">
                        <input type="hidden" id="editForumId" name="id">

                        <div class="mb-3">
                            <label for="editForumTitle" class="form-label">Title</label>
                            <input type="text" id="editForumTitle" name="titleForum" class="form-control">

                        </div>
                        <div class="mb-3">
                            <label for="editForumDescription" class="form-label">Description</label>
                            <textarea id="editForumDescription" name="descriptionForum" class="form-control"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editForumCategory" class="form-label">Category</label>
                            <input type="text" id="editForumCategory" name="category" class="form-control">
                        </div>
													<div id="error-message" style="color: red; margin-top: 10px;"></div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"         
 data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary"  id="saveEdit">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

	<!-- Delete Confirmation Modal -->
	<div class="modal fade" id="deleteForumModal" tabindex="-1" aria-labelledby="deleteForumModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteForumModalLabel">Confirm Deletion</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					Are you sure you want to delete this forum?
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
					<form id="deleteForumForm" method="post" data-turbo="false">
						<input type="hidden" name="_token" id="deleteCsrfToken">
						<button type="submit" class="btn btn-danger btn-sm" id="savedeletion">Delete</button>
					</form>


				</div>
			</div>
		</div>
	</div>

	<script>
		// Here iam Handling edit form submission

document.addEventListener("DOMContentLoaded", function () {
document.querySelectorAll(".edit-button").forEach(button => {
button.addEventListener("click", function () {
document.getElementById("editForumId").value = this.getAttribute("data-id");
document.getElementById("editForumTitle").value = this.getAttribute("data-title");
document.getElementById("editForumDescription").value = this.getAttribute("data-description");
document.getElementById("editForumCategory").value = this.getAttribute("data-category");

});
});

document.getElementById("saveEdit").addEventListener("click", function () {
const form = document.getElementById("editForumForm");
const formData = new FormData(form);

        const errorMessageDiv = document.getElementById("error-message");

// Clear previous error messages
errorMessageDiv.innerText = "";

fetch("/forum/edit/" + document.getElementById("editForumId").value, {
method: "POST",
body: formData
}).then(response => response.json()).then(data => {
if (data.status === "success") {
location.reload();

} else {
if (errorMessageDiv && data.message) {
errorMessageDiv.innerText = data.message;
console.log(errorMessageDiv.innerText )
}}
});
});


// Here iam Handling create form submission
document.getElementById("saveCreate").addEventListener("click", async function () {
const form = document.getElementById("createForumForm");
const formData = new FormData(form);
const errorMessageDiv = document.getElementById("error-message");
    event.preventDefault(); // Prevent default form submission

// Clear previous error messages
document.querySelectorAll(".error-message").forEach(div => div.innerText = "");
if (errorMessageDiv) 
errorMessageDiv.innerText = "";


fetch("/forum/create", {
method: "POST",
body: formData
}).then(response => response.json()).then(data => {
if (data.status === "success") {
location.reload();
} else {
console.error('Error creating forum:', data.message);

// Display general error message (if exists)
if (errorMessageDiv && data.message) {
errorMessageDiv.innerText = data.message;
}

// Display field-specific errors
if (data.errors) {
Object.keys(data.errors).forEach(field => {
const errorDiv = document.getElementById (`${field}-error`);
if (errorDiv) {
errorDiv.innerText = data.errors[field]; // Show error under the correct field
}
});
}
}
}).catch(error => {
console.error("Error during fetch:", error);
if (errorMessageDiv) {
errorMessageDiv.innerText = "An error occurred. Please try again.";
}
});
});

// Here iam Handling deletion of forum

document.querySelectorAll(".delete-button").forEach(button => {
button.addEventListener("click", function () {
var forumId = this.getAttribute("data-id");
var deleteForm = document.getElementById("deleteForumForm");
deleteForm.action = "/forum/" + forumId;

// I set the CSRF token dynamically
var csrfTokenInput = document.getElementById("deleteCsrfToken");
csrfTokenInput.value = this.getAttribute("data-csrf");


});


});

});

	</script>
{% endblock %}
